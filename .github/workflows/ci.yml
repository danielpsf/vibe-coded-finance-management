name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Security Scans (run in parallel)
  backend-security-scan:
    name: Backend Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: ./backend/requirements.txt

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety pip-audit

    - name: Run Bandit Security Linter
      run: |
        cd backend
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -ll

    - name: Check Dependencies with pip-audit
      run: |
        cd backend
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit

    - name: Upload Security Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-security-reports
        path: |
          backend/bandit-report.json
          backend/pip-audit-report.json

  frontend-security-scan:
    name: Frontend Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Run npm audit
      run: |
        cd frontend
        npm audit --audit-level=moderate || true

    - name: Run ESLint Security Checks
      run: |
        cd frontend
        npm run lint || true

  docker-security-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend Docker image
      run: |
        cd backend
        docker build -t finance-backend:test .

    - name: Build frontend Docker image
      run: |
        cd frontend
        docker build -t finance-frontend:test .

    - name: Run Trivy vulnerability scanner (backend)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'finance-backend:test'
        format: 'sarif'
        output: 'trivy-backend-results.sarif'

    - name: Run Trivy vulnerability scanner (frontend)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'finance-frontend:test'
        format: 'sarif'
        output: 'trivy-frontend-results.sarif'

    - name: Upload Trivy scan results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: trivy-scan-results
        path: |
          trivy-backend-results.sarif
          trivy-frontend-results.sarif

  # Backend Tests (run in parallel after security)
  backend-unit-tests:
    name: Backend Unit Tests
    needs: backend-security-scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: ./backend/requirements.txt

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run unit tests in parallel
      run: |
        cd backend
        python -m pytest tests/unit/ -v -n auto

    - name: Generate coverage report
      run: |
        cd backend
        python -m pytest tests/unit/ --cov=. --cov-report=xml

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/coverage.xml
        flags: backend-unit
        name: backend-unit-coverage

  backend-integration-tests:
    name: Backend Integration Tests
    needs: backend-security-scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: ./backend/requirements.txt

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run integration tests in parallel
      run: |
        cd backend
        python -m pytest tests/integration/ -v -n auto

  # Frontend Tests (run in parallel after security)
  frontend-unit-tests:
    name: Frontend Unit Tests
    needs: frontend-security-scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Run unit tests
      run: |
        cd frontend
        npm test -- --run --reporter=verbose

    - name: Generate coverage report
      run: |
        cd frontend
        npm run coverage

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        directory: ./frontend/coverage
        flags: frontend-unit
        name: frontend-unit-coverage

  frontend-e2e-tests:
    name: Frontend E2E Tests
    needs: frontend-security-scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Install Playwright Browsers
      run: |
        cd frontend
        npx playwright install --with-deps

    - name: Start backend server
      run: |
        cd backend
        pip install -r requirements.txt
        python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
        sleep 5
        curl http://localhost:8000/api/health

    - name: Run E2E tests
      run: |
        cd frontend
        npm run e2e

    - name: Upload Playwright report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: ./frontend/playwright-report/
        retention-days: 30

  # Docker Tests
  docker-compose-test:
    name: Docker Compose Test
    needs: [docker-security-scan]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and start services
      run: |
        docker-compose up -d --build
        sleep 15

    - name: Test backend health
      run: |
        curl -f http://localhost:8000/api/health || exit 1

    - name: Test frontend availability
      run: |
        curl -f http://localhost:5173 || exit 1

    - name: Run backend tests in container
      run: |
        docker-compose exec -T backend python -m pytest tests/ -v

    - name: Cleanup
      if: always()
      run: docker-compose down -v